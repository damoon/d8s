apiVersion: batch/v1
kind: Job
metadata:
  name: test-tilt-ci
spec:
  backoffLimit: 0
  template:
    metadata:
      name: test-tilt-ci
    spec:
      serviceAccountName: wedding
      containers:
        - name: test
          image: testing-image
          command:
            - bash
            - -c
            - |
              set -euxo pipefail

              kubectl config set-cluster ci --server=https://${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT} --certificate-authority=/run/secrets/kubernetes.io/serviceaccount/ca.crt
              kubectl config set-credentials ci --token=$(cat /run/secrets/kubernetes.io/serviceaccount/token)
              kubectl config set-context ci --cluster=ci --user=ci --namespace=$(cat /run/secrets/kubernetes.io/serviceaccount/namespace)
              kubectl config use-context ci

              cd tilt

              tilt ci

              sleep 10

              curl --fail -o a http://service-a/
              curl --fail -o b http://service-b/

              echo a > a_
              echo b > b_

              diff a a_
              diff b b_

              tilt down

              echo "done"

              sleep 120
          env:
            - name: "DOCKER_HOST"
              value: "tcp://wedding:2376"
      restartPolicy: Never
