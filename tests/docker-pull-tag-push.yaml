apiVersion: batch/v1
kind: Job
metadata:
  name: test-docker-pull-tag-push
spec:
  backoffLimit: 0
  template:
    metadata:
      name: test-docker-pull-tag-push
    spec:
      containers:
        - name: test
          image: testing-image
          command:
            - bash
            - -c
            - |
              set -euxo pipefail

              docker pull mirror.gcr.io/library/alpine
              if docker pull mirror.gcr.io/library/missing; then echo "this should fail"; false; else echo "exit code propagated"; fi

              docker tag mirror.gcr.io/library/alpine wedding-registry:5000/test-push:alpine
              if docker tag missing b; then echo "this should fail"; false; else echo "exit code propagated"; fi

              docker push wedding-registry:5000/test-push:alpine
              if docker push missing; then echo "this should fail"; false; else echo "exit code propagated"; fi

              echo "done"
          env:
            - name: "DOCKER_HOST"
              value: "tcp://wedding:2376"
      restartPolicy: Never
